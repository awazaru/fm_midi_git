/* Name: Frequency modulation oscillator with MIDI
 * Author:awazaru
 * Micro Controller :Atmega328P
 * Date :10/03/2016
 */

#include <avr/io.h>
#include <avr/interrupt.h>

/*シリアル通信UART*/
#define FOSC   20000000//動作周波数
#define BAUD   2400//ボーレート
#define MYUBRR (FOSC/16/BAUD)-1


/*sinテーブル*/
/*キャリア用テーブル(変調をかけられる側)*/
uint8_t c_sin[360]={130,131,134,136,139,140,143,145,148,149,152,154,156,158,161,163,164,167,170,171,173,175,177,180,181,184,185,187,189,191,194,195,196,199,200,203,204,207,208,209,212,213,214,215,218,219,221,222,223,226,227,228,230,231,232,233,235,236,237,238,238,240,241,242,244,244,245,246,246,247,249,249,250,250,251,251,251,252,252,252,254,254,254,254,255,255,255,255,255,255,255,255,255,255,255,254,254,254,254,252,252,252,251,251,251,250,250,249,249,247,246,246,245,244,244,242,241,240,238,238,237,236,235,233,232,231,230,228,227,226,223,222,221,219,218,215,214,213,212,209,208,207,204,203,200,199,196,195,194,191,189,187,185,184,181,180,177,175,173,171,170,167,164,163,161,158,156,154,152,149,148,145,143,140,139,136,134,131,130,128,125,124,121,119,116,115,112,110,107,106,103,101,99,97,94,92,91,88,85,84,82,80,78,75,74,71,70,68,66,64,61,60,59,56,55,52,51,48,47,46,43,42,41,40,37,36,34,33,32,29,28,27,26,24,23,22,20,19,18,17,17,15,14,13,11,11,10,9,9,8,6,6,5,5,4,4,4,3,3,3,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,3,3,3,4,4,4,5,5,6,6,8,9,9,10,11,11,13,14,15,17,17,18,19,20,22,23,24,26,27,28,29,32,33,34,36,37,40,41,42,43,46,47,48,51,52,55,56,59,60,61,64,66,68,70,71,74,75,78,80,82,84,85,88,91,92,94,97,99,101,103,106,107,110,112,115,116,119,121,124,125,128};
/*モジュレーション用テーブル(変調をかける側)*/
int8_t m_sin[360]={0,0,1,1,1,1,1,1,2,2,2,2,2,2,3,3,3,3,3,3,4,4,4,4,4,4,5,5,5,5,5,5,5,6,6,6,6,6,6,6,7,7,7,7,7,7,7,7,8,8,8,8,8,8,8,8,8,8,9,9,9,9,9,9,9,9,9,9,9,9,9,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,9,9,9,9,9,9,9,9,9,9,9,9,9,8,8,8,8,8,8,8,8,8,8,7,7,7,7,7,7,7,7,6,6,6,6,6,6,6,5,5,5,5,5,5,5,4,4,4,4,4,4,3,3,3,3,3,3,2,2,2,2,2,2,1,1,1,1,1,1,0,0,0,0,0,-1,-1,-1,-1,-1,-1,-2,-2,-2,-2,-2,-2,-3,-3,-3,-3,-3,-3,-4,-4,-4,-4,-4,-4,-5,-5,-5,-5,-5,-5,-5,-6,-6,-6,-6,-6,-6,-6,-7,-7,-7,-7,-7,-7,-7,-7,-8,-8,-8,-8,-8,-8,-8,-8,-8,-8,-9,-9,-9,-9,-9,-9,-9,-9,-9,-9,-9,-9,-9,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-10,-9,-9,-9,-9,-9,-9,-9,-9,-9,-9,-9,-9,-9,-8,-8,-8,-8,-8,-8,-8,-8,-8,-8,-7,-7,-7,-7,-7,-7,-7,-7,-6,-6,-6,-6,-6,-6,-6,-5,-5,-5,-5,-5,-5,-5,-4,-4,-4,-4,-4,-4,-3,-3,-3,-3,-3,-3,-2,-2,-2,-2,-2,-2,-1,-1,-1,-1,-1,-1,0,0,0};


/*カウンタ変数*/
uint8_t sin_count=0;
uint16_t sound_count=0;
uint8_t buf_count=0;//シリアル通信割り込みのバッファを制御するカウンタ


/*グロ-バル変数*/
uint8_t buf_OCR1A[10]={"0"}; //シリアル通信割り込みで使用するバッファ
uint16_t ch_OCR1A=0;


void serial_ini(void){
  UCSR0A=0b00000000;//受信すると10000000 送信有効になると00100000
  UCSR0B|=_BV(RXCIE0)|_BV(RXEN0)|_BV(TXEN0);//送受信有効,受信割り込み許可
  UCSR0C=0b00000110;//データ8bit、非同期、バリティなし、stop1bit
}

unsigned char rx_usart(void)//受信用関数
{
  while( !(UCSR0A & (1<<RXC0)) );                //受信完了待機
  return UDR0;                                //受信ﾃﾞｰﾀ返す
}

void tx_usart(unsigned char data)//送信用関数
{
  while( !(UCSR0A & (1<<UDRE0)) );        //送信ﾊﾞｯﾌｧ空き待機
  UDR0 = data;
}

void puts_tx(char *str)//文字列送信用関数
{
  while( *str != 0x00 ) //nullになるまで実行
    {
	 tx_usart(*str);
	 str++;                                    //ｱﾄﾞﾚｽ+10    }
    }
}

ISR(USART_RX_vect){//シリアル通信割り込み
   unsigned char ch=1;
   ch = rx_usart();
   tx_usart(ch);
   /*   if(ch==1)
	   OCR1A=OCR1A+100;
   */
}


void timer_ini(void){
  //16bitタイマ タイマ割り込み用
  TCCR1B|=_BV(WGM12)|_BV(CS10);//0CR1A基準 比較一致タイマ 分周なし
  TIMSK1|=_BV(OCIE1A);//比較A一致割り込み有効
  OCR1A=454;//44.1kHz
  
  //8bitタイマ PWM用
  TCCR0A|=_BV(COM0A1)|_BV(WGM01)|_BV(WGM00);//高速PWM 比較一致でLOW OC0Aピン
  TCCR0B|=_BV(CS00);
  OCR0A=0;
}

ISR(TIMER1_COMPA_vect){//タイマ1A比較一致割り込み
  uint8_t mod=sin_count+m_sin[2*sin_count];//ここを変更することで色が変わる
  OCR0A=c_sin[mod];//出力
  sin_count++;
  if(sin_count>359){
    sin_count=0;
  }
}

void pin_ini(void){
  DDRD|=_BV(PIN6);
}

int main(void)
{
  pin_ini();
  timer_ini();
  serial_ini();
  sei();//割り込み有効
    for(;;){
    }
    return 0;
}
